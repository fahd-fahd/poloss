#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import discord
from discord.ext import commands
import re
import asyncio

class VoiceControl(commands.Cog):
    """ุงูุชุญูู ุจุงููููุงุช ุงูุตูุชูุฉ"""
    
    def __init__(self, bot):
        self.bot = bot
        self.volume_levels = {}  # ุชุฎุฒูู ูุณุชููุงุช ุงูุตูุช ููู ููุงุฉ
    
    @commands.command(
        name="ุตูุช",
        aliases=["voice", "v", "ุงูุถูุงู_ุตูุชู"],
        description="ุงูุงูุถูุงู ุฅูู ููุงุฉ ุตูุชูุฉ ุฃู ุงูุชุญูู ุจุงูุตูุช"
    )
    async def voice(self, ctx, *, channel_or_volume: str = None):
        """
        ุงูุงูุถูุงู ุฅูู ููุงุฉ ุตูุชูุฉ ุฃู ุถุจุท ูุณุชูู ุงูุตูุช
        
        ุงููุนููุงุช:
            channel_or_volume (str): ุงุณู ุงูููุงุฉ ุฃู ูุนุฑููุง ุฃู ูุณุชูู ุงูุตูุช (0-100)
        
        ุฃูุซูุฉ:
            !ุตูุช ุนุงู - ููุงูุถูุงู ุฅูู ููุงุฉ ุงุณููุง "ุนุงู"
            !ุตูุช 50 - ูุถุจุท ูุณุชูู ุงูุตูุช ุนูู 50%
        """
        # ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ูุนููุงุช
        if not channel_or_volume:
            # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูู ููุงุฉ ุตูุชูุฉ
            if not ctx.author.voice:
                embed = discord.Embed(
                    title="โ ุฎุทุฃ",
                    description="ุฃูุช ูุณุช ูู ููุงุฉ ุตูุชูุฉ! ูุฑุฌู ุงูุงูุถูุงู ุฅูู ููุงุฉ ุตูุชูุฉ ุฃููุงู ุฃู ุชุญุฏูุฏ ุงุณู ุงูููุงุฉ.",
                    color=discord.Color.red()
                )
                return await ctx.send(embed=embed)
            
            # ุงูุงูุถูุงู ุฅูู ููุงุฉ ุงููุณุชุฎุฏู
            channel = ctx.author.voice.channel
            embed = await self._join_voice_channel(ctx, channel)
            return await ctx.send(embed=embed)
        
        # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุนููุฉ ูู ูุณุชูู ุตูุช
        if channel_or_volume.isdigit() or (channel_or_volume.startswith('-') and channel_or_volume[1:].isdigit()):
            # ุชุบููุฑ ูุณุชูู ุงูุตูุช
            volume = int(channel_or_volume)
            embed = await self._set_volume(ctx, volume)
            return await ctx.send(embed=embed)
        
        # ุงูุจุญุซ ุนู ุงูููุงุฉ ุงูุตูุชูุฉ
        channel = discord.utils.get(ctx.guild.voice_channels, name=channel_or_volume)
        
        # ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงุฉุ ูุฏ ูููู ูุนุฑู
        if not channel:
            try:
                # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ูุนุฑู ููุงุฉ
                if channel_or_volume.isdigit():
                    channel_id = int(channel_or_volume)
                    channel = discord.utils.get(ctx.guild.voice_channels, id=channel_id)
                
                # ูุฏ ูููู ููุดู ููููุงุฉ
                elif channel_or_volume.startswith('<#') and channel_or_volume.endswith('>'):
                    channel_id = int(channel_or_volume[2:-1])
                    channel = discord.utils.get(ctx.guild.voice_channels, id=channel_id)
            except:
                pass
        
        # ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงุฉ
        if not channel:
            embed = discord.Embed(
                title="โ ููุงุฉ ุบูุฑ ููุฌูุฏุฉ",
                description=f"ูู ูุชู ุงูุนุซูุฑ ุนูู ููุงุฉ ุตูุชูุฉ ุจุงุณู ุฃู ูุนุฑู: {channel_or_volume}",
                color=discord.Color.red()
            )
            
            # ุนุฑุถ ุงููููุงุช ุงููุชุงุญุฉ
            voice_channels = ctx.guild.voice_channels
            if voice_channels:
                channels_list = "\n".join([f"โข {vc.name}" for vc in voice_channels[:10]])
                if len(voice_channels) > 10:
                    channels_list += f"\n... ู{len(voice_channels) - 10} ูููุงุช ุฃุฎุฑู"
                
                embed.add_field(
                    name="๐ข ุงููููุงุช ุงูุตูุชูุฉ ุงููุชุงุญุฉ:",
                    value=channels_list,
                    inline=False
                )
            
            return await ctx.send(embed=embed)
        
        # ุงูุงูุถูุงู ุฅูู ุงูููุงุฉ ุงููุญุฏุฏุฉ
        embed = await self._join_voice_channel(ctx, channel)
        await ctx.send(embed=embed)
    
    @commands.command(
        name="ุตูุช_ุฏุนูุฉ",
        aliases=["voice_invite", "vi", "ุฏุนูุฉ_ุตูุช"],
        description="ุฏุนูุฉ ูุณุชุฎุฏู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ ุงูุญุงููุฉ"
    )
    async def voice_invite(self, ctx, user: discord.Member = None):
        """
        ุฏุนูุฉ ูุณุชุฎุฏู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ ุงูุญุงููุฉ
        
        ุงููุนููุงุช:
            user (discord.Member): ุงููุณุชุฎุฏู ุงููุฑุงุฏ ุฏุนูุชู
        """
        # ุงูุชุญูู ูู ุชุญุฏูุฏ ูุณุชุฎุฏู
        if not user:
            embed = discord.Embed(
                title="โ ุฎุทุฃ",
                description="ูุฑุฌู ุชุญุฏูุฏ ุงููุณุชุฎุฏู ุงููุฑุงุฏ ุฏุนูุชู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ.",
                color=discord.Color.red()
            )
            return await ctx.send(embed=embed)
        
        # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุจูุช ูู ููุงุฉ ุตูุชูุฉ
        if not ctx.guild.voice_client or not ctx.guild.voice_client.channel:
            # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูู ููุงุฉ ุตูุชูุฉ
            if not ctx.author.voice:
                embed = discord.Embed(
                    title="โ ุฎุทุฃ",
                    description="ุฃูุช ูุณุช ูู ููุงุฉ ุตูุชูุฉ! ูุฑุฌู ุงูุงูุถูุงู ุฅูู ููุงุฉ ุตูุชูุฉ ุฃููุงู.",
                    color=discord.Color.red()
                )
                return await ctx.send(embed=embed)
            
            # ุงูุงูุถูุงู ุฅูู ููุงุฉ ุงููุณุชุฎุฏู
            channel = ctx.author.voice.channel
            await self._join_voice_channel(ctx, channel)
        
        # ุงูุญุตูู ุนูู ุงูููุงุฉ ุงูุตูุชูุฉ ุงูุญุงููุฉ
        voice_channel = ctx.guild.voice_client.channel
        
        # ุฅูุดุงุก ุฑุงุจุท ุฏุนูุฉ ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ
        try:
            # ุฅูุดุงุก ุฏุนูุฉ ููููุงุฉ ุงูุตูุชูุฉ
            invite = await voice_channel.create_invite(
                max_age=60,  # 1 ุฏูููุฉ
                max_uses=1,  # ุงุณุชุฎุฏุงู ูุงุญุฏ ููุท
                temporary=False,
                unique=True
            )
            
            # ุฅุฑุณุงู ุงูุฏุนูุฉ ุฅูู ุงููุณุชุฎุฏู
            embed = discord.Embed(
                title="๐ ุฏุนูุฉ ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ",
                description=f"{ctx.author.mention} ูุฏุนูู ููุงูุถูุงู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ **{voice_channel.name}**",
                color=discord.Color.blue()
            )
            
            embed.add_field(
                name="๐ฉ ุฑุงุจุท ุงูุฏุนูุฉ",
                value=f"[ุงููุฑ ููุง ููุงูุถูุงู]({invite.url})",
                inline=False
            )
            
            embed.set_footer(text="ุชูุชูู ุตูุงุญูุฉ ูุฐู ุงูุฏุนูุฉ ุจุนุฏ ุฏูููุฉ ูุงุญุฏุฉ")
            
            # ุฅุฑุณุงู ุงูุฏุนูุฉ ุฅูู ุงููุณุชุฎุฏู ูู ุงูุฎุงุต
            try:
                await user.send(embed=embed)
                
                # ุฅุฑุณุงู ุชุฃููุฏ ุฅูู ุงูููุงุฉ
                confirm_embed = discord.Embed(
                    title="โ ุชู ุฅุฑุณุงู ุงูุฏุนูุฉ",
                    description=f"ุชู ุฅุฑุณุงู ุฏุนูุฉ ุฅูู {user.mention} ููุงูุถูุงู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ **{voice_channel.name}**.",
                    color=discord.Color.green()
                )
                await ctx.send(embed=confirm_embed)
            except discord.Forbidden:
                # ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุง ูุณูุญ ุจุงูุฑุณุงุฆู ุงูุฎุงุตุฉ
                error_embed = discord.Embed(
                    title="โ ุชุนุฐุฑ ุฅุฑุณุงู ุงูุฏุนูุฉ",
                    description=f"ุชุนุฐุฑ ุฅุฑุณุงู ุงูุฏุนูุฉ ุฅูู {user.mention} ูุฃูู ูุง ูุณูุญ ุจุงูุฑุณุงุฆู ุงูุฎุงุตุฉ.\n\n"
                              f"ุฑุงุจุท ุงูุฏุนูุฉ: {invite.url}",
                    color=discord.Color.red()
                )
                await ctx.send(embed=error_embed)
        
        except discord.Forbidden:
            embed = discord.Embed(
                title="โ ุฎุทุฃ ูู ุงูุตูุงุญูุงุช",
                description="ููุณ ูุฏู ุตูุงุญูุฉ ูุฅูุดุงุก ุฏุนูุฉ ููููุงุฉ ุงูุตูุชูุฉ.",
                color=discord.Color.red()
            )
            await ctx.send(embed=embed)
        
        except Exception as e:
            embed = discord.Embed(
                title="โ ุฎุทุฃ",
                description=f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุฏุนูุฉ: {str(e)}",
                color=discord.Color.red()
            )
            await ctx.send(embed=embed)
    
    @commands.command(
        name="ุบุงุฏุฑ",
        aliases=["leave", "disconnect", "ูุทุน"],
        description="ูุบุงุฏุฑุฉ ุงูููุงุฉ ุงูุตูุชูุฉ"
    )
    async def leave(self, ctx):
        """ูุบุงุฏุฑุฉ ุงูููุงุฉ ุงูุตูุชูุฉ ุงูุญุงููุฉ"""
        # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุจูุช ูู ููุงุฉ ุตูุชูุฉ
        if not ctx.guild.voice_client:
            embed = discord.Embed(
                title="โ ุฎุทุฃ",
                description="ุฃูุง ูุณุช ูู ููุงุฉ ุตูุชูุฉ!",
                color=discord.Color.red()
            )
            return await ctx.send(embed=embed)
        
        # ุงูุญุตูู ุนูู ุงุณู ุงูููุงุฉ ูุจู ุงููุบุงุฏุฑุฉ
        channel_name = ctx.guild.voice_client.channel.name
        
        # ูุบุงุฏุฑุฉ ุงูููุงุฉ ุงูุตูุชูุฉ
        await ctx.guild.voice_client.disconnect()
        
        # ุชูุธูู ุงูุจูุงูุงุช
        if ctx.guild.id in self.volume_levels:
            del self.volume_levels[ctx.guild.id]
        
        # ุฅุฑุณุงู ุชุฃููุฏ
        embed = discord.Embed(
            title="๐ ุชูุช ุงููุบุงุฏุฑุฉ",
            description=f"ุชูุช ูุบุงุฏุฑุฉ ุงูููุงุฉ ุงูุตูุชูุฉ **{channel_name}**.",
            color=discord.Color.blue()
        )
        await ctx.send(embed=embed)
    
    async def _join_voice_channel(self, ctx, channel):
        """ุงูุงูุถูุงู ุฅูู ููุงุฉ ุตูุชูุฉ"""
        try:
            # ุฅุฐุง ูุงู ุงูุจูุช ูุชุตูุงู ุจุงููุนู
            if ctx.guild.voice_client:
                # ุฅุฐุง ูุงู ุงูุจูุช ูู ููุณ ุงูููุงุฉ
                if ctx.guild.voice_client.channel.id == channel.id:
                    embed = discord.Embed(
                        title="โน๏ธ ูุนูููุฉ",
                        description=f"ุฃูุง ุจุงููุนู ูู ุงูููุงุฉ ุงูุตูุชูุฉ **{channel.name}**.",
                        color=discord.Color.blue()
                    )
                    
                    # ุฅุถุงูุฉ ูุนูููุงุช ูุณุชูู ุงูุตูุช
                    current_volume = self.volume_levels.get(ctx.guild.id, 100)
                    embed.add_field(
                        name="๐ ูุณุชูู ุงูุตูุช ุงูุญุงูู",
                        value=f"{current_volume}%",
                        inline=True
                    )
                    
                    return embed
                
                # ุงูุงูุชูุงู ุฅูู ุงูููุงุฉ ุงูุฌุฏูุฏุฉ
                await ctx.guild.voice_client.move_to(channel)
            else:
                # ุงูุงูุถูุงู ุฅูู ุงูููุงุฉ
                await channel.connect()
            
            # ุชุนููู ูุณุชูู ุงูุตูุช ุงูุงูุชุฑุงุถู
            self.volume_levels[ctx.guild.id] = 100
            
            # ุฅุนุฏุงุฏ ุฑุณุงูุฉ ุงููุฌุงุญ
            embed = discord.Embed(
                title="โ ุชู ุงูุงูุถูุงู",
                description=f"ุชู ุงูุงูุถูุงู ุฅูู ุงูููุงุฉ ุงูุตูุชูุฉ **{channel.name}**.",
                color=discord.Color.green()
            )
            
            # ุฅุถุงูุฉ ูุนูููุงุช ุงูููุงุฉ
            embed.add_field(
                name="๐ฅ ุนุฏุฏ ุงูุฃุนุถุงุก",
                value=f"{len(channel.members) - 1} ุนุถู",  # ุทุฑุญ 1 ููุจูุช
                inline=True
            )
            
            embed.add_field(
                name="๐ ูุณุชูู ุงูุตูุช",
                value="100%",
                inline=True
            )
            
            return embed
        
        except discord.ClientException as e:
            return discord.Embed(
                title="โ ุฎุทุฃ",
                description=f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงูุถูุงู ุฅูู ุงูููุงุฉ: {str(e)}",
                color=discord.Color.red()
            )
    
    async def _set_volume(self, ctx, volume):
        """ุถุจุท ูุณุชูู ุงูุตูุช"""
        # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุจูุช ูู ููุงุฉ ุตูุชูุฉ
        if not ctx.guild.voice_client:
            return discord.Embed(
                title="โ ุฎุทุฃ",
                description="ุฃูุง ูุณุช ูู ููุงุฉ ุตูุชูุฉ! ุงุณุชุฎุฏู `!ุตูุช [ุงุณู ุงูููุงุฉ]` ููุงูุถูุงู ุฃููุงู.",
                color=discord.Color.red()
            )
        
        # ุงูุชุญูู ูู ุตุญุฉ ูุณุชูู ุงูุตูุช
        if volume < 0:
            volume = 0
        elif volume > 100:
            volume = 100
        
        # ุชุฎุฒูู ูุณุชูู ุงูุตูุช
        self.volume_levels[ctx.guild.id] = volume
        
        # ุฅุฐุง ูุงู ุงูุจูุช ูุดุบู ููุณูููุ ุถุจุท ูุณุชูู ุงูุตูุช
        if hasattr(ctx.guild.voice_client, 'source') and ctx.guild.voice_client.source:
            ctx.guild.voice_client.source.volume = volume / 100
        
        # ุฅูุดุงุก ุฑุณุงูุฉ ุชุฃููุฏ
        embed = discord.Embed(
            title="๐ ูุณุชูู ุงูุตูุช",
            description=f"ุชู ุถุจุท ูุณุชูู ุงูุตูุช ุนูู **{volume}%**.",
            color=discord.Color.blue()
        )
        
        # ุฅุถุงูุฉ ูุนูููุงุช ุงูููุงุฉ
        embed.add_field(
            name="๐ข ุงูููุงุฉ ุงูุตูุชูุฉ",
            value=ctx.guild.voice_client.channel.name,
            inline=True
        )
        
        # ุฅุถุงูุฉ ุดุฑูุท ูุณุชูู ุงูุตูุช
        volume_bar = self._create_volume_bar(volume)
        embed.add_field(
            name="ูุณุชูู ุงูุตูุช",
            value=volume_bar,
            inline=False
        )
        
        return embed
    
    def _create_volume_bar(self, volume):
        """ุฅูุดุงุก ุดุฑูุท ูุฑุฆู ููุณุชูู ุงูุตูุช"""
        filled = int(volume / 5)  # 20 ุดุฑูุท ูุญุฏ ุฃูุตู
        empty = 20 - filled
        
        bar = "โฐ" * filled + "โฑ" * empty
        return f"{bar} {volume}%"


async def setup(bot):
    """ุฅุนุฏุงุฏ ุงูุฃูุฑ ูุฅุถุงูุชู ุฅูู ุงูุจูุช"""
    await bot.add_cog(VoiceControl(bot)) 